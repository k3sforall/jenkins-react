apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: dokjongban-com-https
  namespace: default
  labels:
    app.kubernetes.io/name: dokjongban.com
    app.kubernetes.io/component: ingressroute
    app.kubernetes.io/managed-by: argocd
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "0"
spec:
  entryPoints: [websecure]
  tls:
    secretName: dokjongban-com-tls-secret
  routes:
    # ▼ React 경로 1: /application-kr → React KR 서비스
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/application-kr`)"
      priority: 1250
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-react-kr-service
          port: 80

    # ▼ React 경로 2: /studywithme-kr → React Study 서비스
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/studywithme-kr`)"
      priority: 1240
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-react-study-service
          port: 80

    # ▼ 이하 기존 규칙 유지
    # /check-refrigerator + 특정 헤더/UA/IP → worker 서비스
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/check-refrigerator`) && (HeaderRegexp(`Accept-Language`, `(?i).*ko.*`) || HeaderRegexp(`User-Agent`, `(?i)(googlebot|bingbot|yeti)`) || ClientIP(`127.0.0.1`) || ClientIP(`175.207.29.178`) || ClientIP(`175.196.251.35`) || ClientIP(`121.190.145.249`) || ClientIP(`192.168.0.1`) || ClientIP(`10.42.0.0/16`) || ClientIP(`10.43.0.0/16`))"
      priority: 1150
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-com-worker-service
          port: 80

    # 봇
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/`) && HeaderRegexp(`User-Agent`, `(?i)(googlebot|bingbot|yeti)`)"
      priority: 1100
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-com-service
          port: 80

    # 한국어
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/`) && HeaderRegexp(`Accept-Language`, `(?i).*ko.*`)"
      priority: 1000
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-com-service
          port: 80

    # 내부 IP
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/`) && (ClientIP(`127.0.0.1`) || ClientIP(`175.207.29.178`) || ClientIP(`175.196.251.35`) || ClientIP(`121.190.145.249`) || ClientIP(`192.168.0.1`) || ClientIP(`10.42.0.0/16`) || ClientIP(`10.43.0.0/16`))"
      priority: 980
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-com-service
          port: 80

    # 나머지 → worker
    - kind: Rule
      match: "(Host(`dokjongban.com`) || Host(`www.dokjongban.com`)) && PathPrefix(`/`) && !HeaderRegexp(`Accept-Language`, `(?i).*ko.*`)"
      priority: 900
      middlewares:
        - name: alt-svc
      services:
        - name: dokjongban-com-worker-service
          port: 80

